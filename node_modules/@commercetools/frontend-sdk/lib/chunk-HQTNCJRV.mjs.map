{"version":3,"sources":["../src/library/Queue.ts"],"sourcesContent":["type QueueItem<T> = {\n\tpromise: () => Promise<unknown>;\n\tresolve: (value: T) => void;\n\treject: (reason?: any) => void;\n};\n\nexport class Queue {\n\t#queue: QueueItem<any>[] = [];\n\t#promisePending = false;\n\t#stopped = false;\n\n\tadd<T>(promise: () => Promise<T>): Promise<T> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#queue.push({\n\t\t\t\tpromise,\n\t\t\t\tresolve,\n\t\t\t\treject,\n\t\t\t});\n\t\t\tthis.#handle();\n\t\t});\n\t}\n\n\tstop() {\n\t\tthis.#stopped = true;\n\t}\n\n\trestart() {\n\t\tthis.#stopped = false;\n\t\tthis.#handle();\n\t}\n\n\t#handle(): void {\n\t\tif (this.#promisePending || this.#stopped) {\n\t\t\treturn;\n\t\t}\n\t\tconst item = this.#queue.shift();\n\t\tif (!item) {\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tthis.#promisePending = true;\n\t\t\t// TODO: check anonamous functions don't mess up stack trace too much\n\t\t\titem.promise()\n\t\t\t\t.then((value) => this.#resolve(() => item.resolve(value)))\n\t\t\t\t.catch((err) => this.#resolve(() => item.reject(err)));\n\t\t} catch (err) {\n\t\t\tthis.#resolve(() => item.reject(err));\n\t\t}\n\t}\n\n\t#resolve(callback: () => void): void {\n\t\tthis.#promisePending = false;\n\t\tcallback();\n\t\tthis.#handle();\n\t}\n}\n"],"mappings":";AAMO,IAAM,QAAN,MAAY;AAAA,EAClB,SAA2B,CAAC;AAAA,EAC5B,kBAAkB;AAAA,EAClB,WAAW;AAAA,EAEX,IAAO,SAAuC;AAC7C,WAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACvC,WAAK,OAAO,KAAK;AAAA,QAChB;AAAA,QACA;AAAA,QACA;AAAA,MACD,CAAC;AACD,WAAK,QAAQ;AAAA,IACd,CAAC;AAAA,EACF;AAAA,EAEA,OAAO;AACN,SAAK,WAAW;AAAA,EACjB;AAAA,EAEA,UAAU;AACT,SAAK,WAAW;AAChB,SAAK,QAAQ;AAAA,EACd;AAAA,EAEA,UAAgB;AACf,QAAI,KAAK,mBAAmB,KAAK,UAAU;AAC1C;AAAA,IACD;AACA,UAAM,OAAO,KAAK,OAAO,MAAM;AAC/B,QAAI,CAAC,MAAM;AACV;AAAA,IACD;AACA,QAAI;AACH,WAAK,kBAAkB;AAEvB,WAAK,QAAQ,EACX,KAAK,CAAC,UAAU,KAAK,SAAS,MAAM,KAAK,QAAQ,KAAK,CAAC,CAAC,EACxD,MAAM,CAAC,QAAQ,KAAK,SAAS,MAAM,KAAK,OAAO,GAAG,CAAC,CAAC;AAAA,IACvD,SAAS,KAAP;AACD,WAAK,SAAS,MAAM,KAAK,OAAO,GAAG,CAAC;AAAA,IACrC;AAAA,EACD;AAAA,EAEA,SAAS,UAA4B;AACpC,SAAK,kBAAkB;AACvB,aAAS;AACT,SAAK,QAAQ;AAAA,EACd;AACD;","names":[]}